<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨Šæ¯æ¨æ’­</title>
    <link rel="stylesheet" href="index.css"></link>
</head>
<body>
    <div id="notification-container" title="å•Ÿç”¨é€šçŸ¥">
        <div id="notification-bell">ğŸ””<span id="notification-dot"></span></div>
    </div>
    <div id="notification-list"></div>

    <script>
        const bell = document.getElementById("notification-container")
        const bellIcon = document.getElementById("notification-bell")
        const dot = document.getElementById("notification-dot")
        const list = document.getElementById("notification-list")

        const hasSubscribed = () => {
            return localStorage.getItem("pushSubscribed") === "yes"
        }

        const markSubscribed = () => {
            localStorage.setItem("pushSubscribed", "yes")
            /* bellIcon.textContent = "âœ…" */
            bellIcon.classList.add("subscribed")
        }

        const setupPush = async () => {
            try{    
                await main()
                //alert("é€šçŸ¥å·²å•Ÿç”¨")
            }catch(err){    
                console.error("æ¨æ’­è¨»å†Šå¤±æ•—: ", err.message)
                //alert("æ¨æ’­æˆæ¬Šå¤±æ•—")
            }
        }

        const onFirstInteraction = async () => {
            if (!hasSubscribed()) {
                try {
                    await setupPush()
                    console.log("ç¬¬ä¸€æ¬¡äº’å‹•å¾Œè¨»å†ŠæˆåŠŸ")
                } catch (e) {
                    console.warn("é€šçŸ¥è¨»å†Šå¤±æ•—ï¼š", e.message)
                }
            }
            window.removeEventListener('click', onFirstInteraction)
        }

        window.addEventListener('click', onFirstInteraction)
        //é»æ“Šéˆ´éº
        bell.addEventListener("click", async () => {
            //éš±è—ç´…é»
            dot.style.display = "none"

            //åˆ‡æ›é€šçŸ¥åˆ—è¡¨é¡¯ç¤º
            list.style.display = list.style.display === "block"?"none":"block"

/*             if(!hasSubscribed()){
                await setupPush()
            } */
        })

        //è¼‰å…¥æ™‚åˆå§‹åŒ–éˆ´éºåœ–ç¤ºç‹€æ…‹ 
        window.addEventListener("DOMContentLoaded", async() => {
            if(hasSubscribed()){
                bellIcon.classList.add("subscribed")
                /* bellIcon.textContent="âœ…" */
            }
        })


//ç”¨ä¾†å°‡ VAPID å…¬é‘°ï¼ˆbase64 æ ¼å¼ï¼‰ è½‰æˆ Uint8Arrayï¼ˆä½å…ƒçµ„é™£åˆ—ï¼‰ï¼Œæˆæ¨æ’­ API å¯ç”¨çš„æ ¼å¼ï¼Œä»¥ä¾¿å‚³å…¥ pushManager.subscribe()ã€‚
const urlBase64ToUnit8Array = base64String => {
    //Base64 è¦æ±‚é•·åº¦æ˜¯ 4 çš„å€æ•¸ã€‚è‹¥ä¸æ˜¯ï¼Œè¦åŠ ä¸Š = è£œé½Šã€‚
    const padding = '='.repeat(( 4 - (base64String.length % 4)) % 4)

    /* Web Push çš„ VAPID å…¬é‘°æ˜¯ "URL-safe Base64" ç‰ˆæœ¬ï¼Œå®ƒæŠŠï¼š
    [+ æ›æˆ -]ã€[/ æ›æˆ _]ï¼Œé€™è£¡æ˜¯è½‰å›åŸå§‹ Base64 å½¢å¼ï¼Œæ‰èƒ½ç”¨  atob() è§£ç¢¼ã€‚*/
    const base64 = (base64String + padding)
        .replace(/\-/g, '+')
        .replace(/_/g, '/')

    //è§£ç¢¼æˆåŸå§‹äºŒé€²ä½è³‡æ–™
    const rawData = atob(base64)
    const outputArray = new Uint8Array(rawData.length)

    //æŠŠè§£ç¢¼å¾Œçš„æ¯å€‹å­—å…ƒè½‰æˆå°æ‡‰çš„ ASCII å€¼
    // base64: "SGVsbG8h" => "Hello!"(atob) => Uint8Array(6) [72, 101, 108, 108, 111, 33], ä¾‹å¦‚ H çš„ ASCII å€¼ 72
    for(let i = 0; i < rawData.length; ++i){
        outputArray[i] = rawData.charCodeAt(i)
    }
    return outputArray
}

const checkPermission = () => {
    //navigator.serviceWorkerï¼šè¨»å†Šèˆ‡ç®¡ç† service worker çš„å…¥å£
    //æª¢æŸ¥æ˜¯å¦æ”¯æ´ service worker
    if(!('serviceWorker' in navigator)){
        throw new Error("No support for service worker!")
    }

    //æª¢æŸ¥æ˜¯å¦æ”¯æ´ã€Œé€šçŸ¥ã€ API
    if(!('Notification' in window)){
        throw new Error("No support for notification API")
    }

    //æª¢æŸ¥æ˜¯å¦æ”¯æ´ã€Œæ¨æ’­ã€API
    if(!('PushManager' in window)){
        throw new Error("No support for Push API")
    }
}

//è¨»å†Šå®Œ Service Worker å¾Œï¼Œå®ƒå°±æœƒé–‹å§‹è™•æ–¼ç›£è½ç‹€æ…‹ï¼Œå¯ä»¥è™•ç†å„ç¨®äº‹ä»¶ï¼ˆå¦‚ push, fetch, sync ç­‰ï¼‰
const registerSW = async () => {
    const registration = await navigator.serviceWorker.register('sw.js')
    return registration
}

const requestNotificationPermission = async () => {
    const permission = await Notification.requestPermission()

    if(permission !== 'granted'){
        throw new Error("Notification permission not granted")
    }
}

//æ¥æ”¶ä¸€å€‹è¨‚é–±ç‰©ä»¶ï¼Œå‘ä¼ºæœå™¨è¨»å†Šè¨‚é–±
const saveSubscription = async (subscription) => {
    const response = await fetch('http://localhost:3000/save-subscription', {
        method: 'post',
        headers: { 'Content-type': "application/json" },
        body: JSON.stringify(subscription)
    })

    if(!response.ok){
        throw new Error(`Server error: ${response.status}`)
    }

    const result = await response.json()
    console.log("Server acknowledged subscription:", result.message)

    return result.message
}

//å‰ç«¯å–æ¶ˆèˆŠè¨‚é–±ï¼Œä½†ä¼ºæœå™¨ä¸Šè¨˜æ†¶é«”è£¡çš„èˆŠè¨‚é–±è³‡æ–™æ²’æœ‰åˆªæ‰ï¼Œå¾Œç«¯éœ€å¦å¤–è™•ç†ï¼Œæ¸¬è©¦ç”¨ï¼Œå¼·åˆ¶å–æ¶ˆè¨‚é–±
/* const unregisterOldSubscription = async (registration) => {
    const subscription = await registration.pushManager.getSubscription()
    
    if(subscription){
        console.log("Found existing subscription, unsubscribing...")
        await subscription.unsubscribe()
        console.log("Old subscription removed.")
    }else{
        console.log("No existing subscription")
    }
} */

// Service Worker å‚³ä¾†è¨Šæ¯ => é¡¯ç¤ºç´…é» + æ–°å¢é€šçŸ¥

const main = async () => {
    //æª¢æŸ¥æ¬Šé™
    checkPermission()
    //è¦æ±‚é–‹å•Ÿé€šçŸ¥æ¬Šé™
    await requestNotificationPermission()
    //è¨»å†Šå®Œ Service Worker å¾Œï¼Œå®ƒå°±æœƒé–‹å§‹è™•æ–¼ç›£è½ç‹€æ…‹ï¼Œå¯ä»¥è™•ç†å„ç¨®äº‹ä»¶ï¼ˆå¦‚ push, fetch, sync ç­‰ï¼‰
    /* const registration = await registerSW() */
    const registration = await navigator.serviceWorker.register('sw.js')
    await navigator.serviceWorker.ready;

    if(!navigator.serviceWorker.controller){
        location.reload();
        return
    }

    // ç§»é™¤èˆŠçš„è¨‚é–±ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œæ¸¬è©¦ç”¨ï¼Œå¼·åˆ¶å–æ¶ˆè¨‚é–±
    /* await unregisterOldSubscription(registration) */
    const subscription = await registration.pushManager.getSubscription()

    //åˆ¤æ–·ç¾ç‹€æ˜¯å¦æœ‰è¨‚é–±
    if(subscription){
        console.log("å·²æœ‰è¨‚é–±ï¼Œç›´æ¥ä½¿ç”¨")
        await saveSubscription(subscription)
    }else{
        // ä½¿ç”¨å…¬é‘°ï¼Œå»ºç«‹æ–°è¨‚é–±
        const newSubscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUnit8Array("BDgiCyiO9piCbZWk_2OFlqy-3zdPmtsCNNADUk1W1za5Z8qx76E9u1j9zkuBJb5QociIoOr4xgLbQTpIoovpN7I")
        })

        await saveSubscription(newSubscription)
    }

    // ç­‰è¨»å†Šå®Œ Service Worker å†ç›£è½ message
    navigator.serviceWorker.ready.then(registration => {
        navigator.serviceWorker.addEventListener("message", event => {
            if(event.data && event.data.type === "new-notification"){
                setTimeout(() => {
                    dot.style.display = "block"
                }, 10)
                const msg = event.data.message || "ä½ æœ‰ä¸€å‰‡æ–°é€šçŸ¥"
                const item = document.createElement("div")
                item.className = "notification-item"
                item.textContent = msg
                list.prepend(item)
            }
        })
    }) 
}

</script>
</body>
</html>